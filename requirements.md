# Healing Clicker - 改修要件定義書

## 1. 概要

### 1.1 現状
- Pygameベースの癒し系クリッカーゲーム
- 単一キャラクター（アニメ風少女）をクリックしてポイント獲得
- 5種のアップグレード（撫でる力、お手伝い妖精、幸運のお守り、黄金の手、妖精軍団）
- クリックアニメーション（ぷにっと）、パーティクル、ポップアップテキスト
- BGM/SE、設定パネル（音量調整）
- オートセーブ、オフライン収益

### 1.2 改修方針
**中規模改修**として、以下の2つを核とする新要素を追加する。

| 優先度 | 新要素 | 狙い |
|--------|--------|------|
| **最優先** | キャラクター交流システム | 癒し体験の深化・キャラへの愛着 |
| **高** | 実績・コレクションシステム | 長期的なやり込みと達成感 |

副次要素として、ランダムイベントとパズル系ミニゲームの土台も設計に含める。

---

## 2. 新機能: キャラクター交流システム

### 2.1 複数キャラクターの導入

#### 2.1.1 キャラクター構成
| キャラ名 | テーマ | 解放条件 |
|----------|--------|----------|
| ハナ（初期キャラ） | 花・春 | 最初から使用可能 |
| ミズキ | 水・夏 | 累計ポイント 10,000 達成 |
| カエデ | 紅葉・秋 | 累計クリック 5,000 回 |
| ユキ | 雪・冬 | 実績を10個達成 |

- 各キャラはプレースホルダーとして `_create_placeholder_character()` と同様の手法で描画を差別化（配色・髪型・装飾を変更）
- 将来的に画像ファイル差し替えに対応できるよう `assets/images/{キャラID}.png` のパスを優先読み込みする設計を維持

#### 2.1.2 キャラ切り替え
- メイン画面に「キャラ切替」ボタンを配置（設定ボタン隣）
- 切替パネルで解放済みキャラ一覧を表示、未解放キャラは条件をヒント表示（シルエット＋解放条件テキスト）
- 選択中のキャラがメイン画面に表示される

### 2.2 好感度システム

#### 2.2.1 好感度パラメータ
- キャラごとに独立した好感度（0〜100）を管理
- 好感度はクリック・アップグレード購入・ログイン時などに加算

| アクション | 好感度加算量 |
|------------|-------------|
| クリック | +0.01 / 回 |
| アップグレード購入 | +0.5 / 回 |
| ゲーム起動（1日1回） | +1.0 |
| ランダムイベント成功 | +2.0 |

#### 2.2.2 好感度レベルと変化
| レベル | 好感度範囲 | 状態名 | 変化内容 |
|--------|-----------|--------|----------|
| 1 | 0〜19 | はじめまして | 基本表情のみ |
| 2 | 20〜39 | 仲良し | にっこり表情追加、クリック時に小さく跳ねるアニメ |
| 3 | 40〜59 | 親友 | 照れ表情追加、ハートパーティクル発生 |
| 4 | 60〜79 | 大好き | 目がキラキラに、特別なクリックエフェクト |
| 5 | 80〜100 | 運命の人 | 虹色パーティクル、専用アニメーション |

#### 2.2.3 アニメーションによるリアクション
- **表情変化**: 好感度レベルに応じて目・口・頬の描画パターンを切替
  - 通常 / にっこり / 照れ / キラキラ / 感動（5段階）
- **クリック反応**: 好感度が上がるほどリアクションが豊かに
  - Lv1: 基本の「ぷにっと」のみ
  - Lv2: ぷにっと + 小ジャンプ
  - Lv3: ぷにっと + ハートエフェクト
  - Lv4: ぷにっと + キラキラエフェクト + 揺れ
  - Lv5: ぷにっと + 虹色パーティクル + 回転
- **アイドルアニメーション**: 放置中にキャラが小さく揺れる、瞬きするなど

### 2.3 好感度の表示
- キャラクターの下部にハートアイコン＋好感度バーを表示
- 好感度レベルアップ時にお祝いエフェクト（大きなハートパーティクル＋ポップアップ）

---

## 3. 新機能: 実績・コレクションシステム

### 3.1 実績一覧

#### 3.1.1 クリック系
| ID | 名称 | 条件 | 報酬 |
|----|------|------|------|
| click_10 | はじめての一歩 | 累計10回クリック | +100pt |
| click_100 | なでなでマスター | 累計100回クリック | +500pt |
| click_1000 | 撫で職人 | 累計1,000回クリック | +5,000pt |
| click_10000 | 伝説の手 | 累計10,000回クリック | +50,000pt |

#### 3.1.2 ポイント系
| ID | 名称 | 条件 | 報酬 |
|----|------|------|------|
| points_1000 | ちょっとした貯金 | 累計1,000pt獲得 | +200pt |
| points_10000 | お金持ちへの道 | 累計10,000pt獲得 | +2,000pt |
| points_100000 | 大富豪 | 累計100,000pt獲得 | +20,000pt |
| points_1000000 | 億万長者 | 累計1,000,000pt獲得 | +200,000pt |

#### 3.1.3 アップグレード系
| ID | 名称 | 条件 | 報酬 |
|----|------|------|------|
| upgrade_first | はじめての強化 | いずれかのアップグレードを1回購入 | +50pt |
| upgrade_10 | 成長中 | アップグレード累計10回購入 | +1,000pt |
| upgrade_all | コンプリーター | 全種類のアップグレードをLv5以上に | +10,000pt |

#### 3.1.4 好感度系
| ID | 名称 | 条件 | 報酬 |
|----|------|------|------|
| affection_20 | 仲良しさん | いずれかのキャラの好感度が20に到達 | +500pt |
| affection_50 | 親友 | いずれかのキャラの好感度が50に到達 | +5,000pt |
| affection_100 | 運命の人 | いずれかのキャラの好感度が100に到達 | +50,000pt |
| affection_all | みんな大好き | 全キャラの好感度を50以上に | +100,000pt |

#### 3.1.5 特殊
| ID | 名称 | 条件 | 報酬 |
|----|------|------|------|
| lucky_hit | ラッキー！ | ラッキーボーナスを初めて発動 | +300pt |
| offline_return | お帰りなさい | オフライン収益を初めて受け取る | +200pt |
| event_first | 不思議な出来事 | ランダムイベントを初めて体験 | +500pt |

### 3.2 実績UI
- メイン画面に「実績」ボタンを配置
- 実績パネル: スクロール可能なリストで全実績を表示
  - 達成済み: カラー表示 + チェックマーク
  - 未達成: グレーアウト + 進捗バー（例: 「57 / 100 クリック」）
- 達成時: 画面上部からスライドインするトースト通知 + 効果音

### 3.3 コレクション図鑑
- 実績パネル内のタブ切替で「図鑑」を表示
- キャラ図鑑: 解放済みキャラのプロフィール（名前・テーマ・好感度レベル）
- 実績達成率の表示（例: 「12 / 20 達成」）

---

## 4. 副次要素: ランダムイベント

### 4.1 基本設計
- **発生頻度**: 10〜20分ごとに1回（ランダム間隔）
- **通知**: キャラが「！」マークを出してプレイヤーに知らせる
- **制限時間**: イベントによって10〜30秒

### 4.2 イベント一覧
| イベント名 | 内容 | 成功報酬 |
|-----------|------|----------|
| ゴールドラッシュ | 10秒間、クリックポイント5倍 | 獲得ポイントをそのまま取得 |
| 流れ星 | 画面を流れる星をクリック（3個） | +現在のクリックパワー x 50 |
| お花畑 | 画面に花が咲く。タップで収穫（5個） | +現在のクリックパワー x 30 |
| 虹の訪問者 | レアキャラがシルエットで登場。クリックすると好感度大幅UP | 選択中キャラの好感度 +5 |

### 4.3 イベント管理
- `EventManager` クラスで管理
- タイマーで次のイベント発生までカウントダウン
- イベント中はアップグレードパネル操作を一時停止（イベントに集中させる）

---

## 5. 副次要素: パズル系ミニゲーム（将来拡張）

### 5.1 設計方針
> 本改修では土台（`MiniGameManager` クラスのスケルトン）のみ実装。
> 具体的なミニゲームは次フェーズで追加。

### 5.2 候補ミニゲーム（次フェーズ向け）
| ゲーム名 | 概要 |
|----------|------|
| カラーマッチ | 同じ色のオーブを3つ揃えて消すシンプルパズル |
| 記憶ゲーム | キャラの表情を覚えて正しい順番にタップ |
| ジグソー | キャラの絵を並べ替えて完成させる |

---

## 6. データ設計

### 6.1 セーブデータ構造（拡張後）

```json
{
  "player": {
    "points": 12345.0,
    "total_points_earned": 50000.0,
    "total_clicks": 3000,
    "upgrade_levels": {
      "click_power": 5,
      "auto_click": 3,
      "lucky_bonus": 2,
      "golden_touch": 1,
      "fairy_army": 0
    }
  },
  "characters": {
    "current_character": "hana",
    "unlocked": ["hana", "mizuki"],
    "affection": {
      "hana": 45.0,
      "mizuki": 12.0,
      "kaede": 0.0,
      "yuki": 0.0
    }
  },
  "achievements": {
    "unlocked": ["click_10", "click_100", "points_1000"],
    "notified": ["click_10", "click_100", "points_1000"]
  },
  "events": {
    "total_events_completed": 5,
    "last_event_time": "2026-02-05T12:34:56"
  },
  "settings": {
    "bgm_volume": 0.5,
    "sfx_volume": 0.7
  },
  "last_played": "2026-02-05T14:00:00",
  "daily_login": "2026-02-05"
}
```

### 6.2 新規設定定数（settings.py 追加分）

```python
# キャラクター定義
CHARACTERS = {
    "hana": {
        "name": "ハナ",
        "theme": "花・春",
        "unlock_condition": None,  # 初期キャラ
        "colors": {
            "hair": (180, 130, 220),
            "ribbon": (255, 150, 180),
            "accent": (255, 218, 185),
        },
    },
    "mizuki": {
        "name": "ミズキ",
        "theme": "水・夏",
        "unlock_condition": {"type": "total_points", "value": 10000},
        "colors": {
            "hair": (100, 180, 255),
            "ribbon": (150, 220, 255),
            "accent": (200, 235, 255),
        },
    },
    "kaede": {
        "name": "カエデ",
        "theme": "紅葉・秋",
        "unlock_condition": {"type": "total_clicks", "value": 5000},
        "colors": {
            "hair": (220, 120, 60),
            "ribbon": (255, 180, 50),
            "accent": (255, 230, 180),
        },
    },
    "yuki": {
        "name": "ユキ",
        "theme": "雪・冬",
        "unlock_condition": {"type": "achievements", "value": 10},
        "colors": {
            "hair": (200, 210, 230),
            "ribbon": (180, 200, 255),
            "accent": (230, 240, 255),
        },
    },
}

# 好感度設定
AFFECTION = {
    "max": 100,
    "levels": [
        {"min": 0,  "name": "はじめまして", "expression": "normal"},
        {"min": 20, "name": "仲良し",       "expression": "smile"},
        {"min": 40, "name": "親友",         "expression": "blush"},
        {"min": 60, "name": "大好き",       "expression": "sparkle"},
        {"min": 80, "name": "運命の人",     "expression": "rainbow"},
    ],
    "gains": {
        "click": 0.01,
        "upgrade": 0.5,
        "daily_login": 1.0,
        "event_success": 2.0,
    },
}

# ランダムイベント設定
EVENT_CONFIG = {
    "min_interval": 600,   # 最短10分
    "max_interval": 1200,  # 最長20分
}

# 実績定義
ACHIEVEMENTS = {
    "click_10":       {"name": "はじめての一歩",   "condition": {"type": "total_clicks",  "value": 10},     "reward": 100},
    "click_100":      {"name": "なでなでマスター", "condition": {"type": "total_clicks",  "value": 100},    "reward": 500},
    "click_1000":     {"name": "撫で職人",         "condition": {"type": "total_clicks",  "value": 1000},   "reward": 5000},
    "click_10000":    {"name": "伝説の手",         "condition": {"type": "total_clicks",  "value": 10000},  "reward": 50000},
    "points_1000":    {"name": "ちょっとした貯金", "condition": {"type": "total_points",  "value": 1000},   "reward": 200},
    "points_10000":   {"name": "お金持ちへの道",   "condition": {"type": "total_points",  "value": 10000},  "reward": 2000},
    "points_100000":  {"name": "大富豪",           "condition": {"type": "total_points",  "value": 100000}, "reward": 20000},
    "points_1000000": {"name": "億万長者",         "condition": {"type": "total_points",  "value": 1000000},"reward": 200000},
    "upgrade_first":  {"name": "はじめての強化",   "condition": {"type": "total_upgrades","value": 1},      "reward": 50},
    "upgrade_10":     {"name": "成長中",           "condition": {"type": "total_upgrades","value": 10},     "reward": 1000},
    "upgrade_all":    {"name": "コンプリーター",   "condition": {"type": "all_upgrades_lv","value": 5},     "reward": 10000},
    "affection_20":   {"name": "仲良しさん",       "condition": {"type": "max_affection", "value": 20},     "reward": 500},
    "affection_50":   {"name": "親友",             "condition": {"type": "max_affection", "value": 50},     "reward": 5000},
    "affection_100":  {"name": "運命の人",         "condition": {"type": "max_affection", "value": 100},    "reward": 50000},
    "affection_all":  {"name": "みんな大好き",     "condition": {"type": "all_affection", "value": 50},     "reward": 100000},
    "lucky_hit":      {"name": "ラッキー！",       "condition": {"type": "first_lucky",   "value": 1},      "reward": 300},
    "offline_return": {"name": "お帰りなさい",     "condition": {"type": "first_offline", "value": 1},      "reward": 200},
    "event_first":    {"name": "不思議な出来事",   "condition": {"type": "first_event",   "value": 1},      "reward": 500},
}
```

---

## 7. ファイル構成（改修後）

```
healing-clicker/
  main.py                  # エントリーポイント（変更なし）
  game.py                  # メインロジック（キャラ管理・イベント統合）
  player.py                # プレイヤーデータ（好感度・実績フラグ追加）
  settings.py              # 定数（CHARACTERS, AFFECTION, ACHIEVEMENTS, EVENT_CONFIG 追加）
  ui.py                    # UI部品（キャラ切替パネル、実績パネル、イベント通知 追加）
  animations.py            # アニメーション（表情・好感度エフェクト追加）
  save_manager.py          # セーブ管理（新データ構造対応）
  sound_manager.py         # サウンド管理（新SE追加対応）
  character_manager.py     # 【新規】キャラクター管理（解放判定・好感度・表情切替）
  achievement_manager.py   # 【新規】実績判定・報酬付与・通知
  event_manager.py         # 【新規】ランダムイベント管理・イベント実行
  assets/
    images/                # キャラ画像（将来用）
    sounds/
      click.wav
      upgrade.wav
      bonus.wav
      achievement.wav      # 【新規】実績達成音
      event_start.wav      # 【新規】イベント開始音
      heart.wav            # 【新規】好感度UP音
    music/
      bgm.wav
    fonts/
```

---

## 8. 実装フェーズ

### Phase 1: キャラクター交流システム
1. `settings.py` に `CHARACTERS`, `AFFECTION` 定数を追加
2. `character_manager.py` を新規作成（キャラ解放判定・好感度管理・表情状態）
3. `animations.py` に表情描画パターン・好感度エフェクトを追加
4. `player.py` にキャラ・好感度データの保持を追加
5. `ui.py` にキャラ切替パネル・好感度バーを追加
6. `game.py` にキャラ管理・好感度更新ロジックを統合
7. `save_manager.py` を拡張データ構造に対応

### Phase 2: 実績・コレクションシステム
1. `settings.py` に `ACHIEVEMENTS` 定数を追加
2. `achievement_manager.py` を新規作成（実績判定・報酬付与・通知管理）
3. `ui.py` に実績パネル（リスト表示・達成トースト）を追加
4. `player.py` に実績トラッキング用の追加データを保持
5. `game.py` に実績チェックのフック・通知表示を統合
6. `save_manager.py` を実績データ保存に対応

### Phase 3: ランダムイベント
1. `settings.py` に `EVENT_CONFIG` を追加
2. `event_manager.py` を新規作成（タイマー管理・イベント実行・報酬付与）
3. `ui.py` にイベント通知UI（「！」マーク・イベント画面）を追加
4. `game.py` にイベントループ統合

### Phase 4: 統合テスト・バランス調整
1. 好感度の上昇速度・実績の達成難易度を調整
2. イベント報酬のバランス確認
3. セーブ/ロードの互換性テスト（旧データからの移行）
4. 全体的なUX確認

---

## 9. 既存機能への影響

| 既存機能 | 影響 | 対応 |
|----------|------|------|
| クリック処理 | 好感度加算・実績チェックのフック追加 | `game._on_character_click()` を拡張 |
| アップグレード購入 | 好感度加算・実績チェックのフック追加 | `game.handle_event()` を拡張 |
| セーブ/ロード | データ構造拡張 | 後方互換: 旧データにキーがなければデフォルト値で補完 |
| メイン画面描画 | 好感度バー・実績ボタン・イベント通知の追加 | `game.draw()` に描画呼び出し追加 |
| 設定パネル | 変更なし | - |
